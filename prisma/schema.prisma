generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(uuid())
  privyId       String?    @unique
  email         String?
  phone         String?
  walletAddress String?
  createdAt     DateTime   @default(now())
  merchants     Merchant[]
}

model Merchant {
  id             String    @id @default(uuid())
  name           String
  ownerUserId    String
  owner          User      @relation(fields: [ownerUserId], references: [id])
  sponsorWallet  String?
  feeToken       String    @default("0x20c0000000000000000000000000000000000001")
  createdAt      DateTime  @default(now())
  products       Product[]
  orders         Order[]
}

model Product {
  id          String   @id @default(uuid())
  merchantId  String
  merchant    Merchant @relation(fields: [merchantId], references: [id])
  name        String
  priceAmount String   // stored as string to avoid bigint issues
  currency    String   @default("AlphaUSD")
  splitJson   String   // JSON string: [{address, percent, label}]
  createdAt   DateTime @default(now())
  orders      Order[]
}

model Order {
  id              String       @id @default(uuid())
  merchantId      String
  merchant        Merchant     @relation(fields: [merchantId], references: [id])
  productId       String
  product         Product      @relation(fields: [productId], references: [id])
  customerPrivyId String?
  customerWallet  String?
  amount          String
  currency        String       @default("AlphaUSD")
  status          String       @default("pending") // pending, processing, settled, failed
  createdAt       DateTime     @default(now())
  nettingRuns     NettingRun[]
}

model NettingRun {
  id           String        @id @default(uuid())
  orderId      String
  order        Order         @relation(fields: [orderId], references: [id])
  runPayload   String        // JSON: the transfer list
  status       String        @default("pending") // pending, executing, completed, failed
  savingsMeta  String?       // JSON
  createdAt    DateTime      @default(now())
  transactions Transaction[]
}

model Transaction {
  id          String     @id @default(uuid())
  runId       String
  run         NettingRun @relation(fields: [runId], references: [id])
  fromAddress String
  toAddress   String
  amount      String
  token       String
  txHash      String?
  memo        String?
  status      String     @default("pending") // pending, confirmed, failed
  createdAt   DateTime   @default(now())
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  merchantId      String
  productId       String
  amount          String
  currency        String   @default("AlphaUSD")
  interval        String   @default("monthly") // weekly, monthly, yearly
  status          String   @default("active")   // active, past_due, cancelled, paused
  customerWallet  String
  merchantWallet  String
  retryCount      Int      @default(0)
  maxRetries      Int      @default(5)
  nextPaymentAt   DateTime
  lastFailedAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PayoutRun {
  id              String   @id @default(uuid())
  merchantId      String?
  csvData         String   // original CSV content
  totalRecipients Int
  totalAmount     String
  completedCount  Int      @default(0)
  failedCount     Int      @default(0)
  nonceLanes      Int      @default(1)
  status          String   @default("pending") // pending, executing, completed, failed
  resultJson      String?  // JSON: PayoutResult[]
  createdAt       DateTime @default(now())
  completedAt     DateTime?
}
